using UnityEngine;
using System.Collections.Generic;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;

/// <summary>
/// 노선 관련 데이터 관리 클래스
/// </summary>
public class LineDataManager: MonoBehaviour
{
    public LineManager lineManager;
    public MessageManager messageManager;
    public PlayManager playManager;

    /// <summary>
    /// 1호선 노선 초기화 작업 (기본 제공 역)
    /// </summary>
    private void InitLine1()
    {
        if (!lineManager.lineCollections[0].lineData.hasStation[24])
            lineManager.lineCollections[0].lineData.hasStation[24] = lineManager.lineCollections[0].lineData.hasStation[33] = lineManager.lineCollections[0].lineData.hasStation[76] = true;
        if (lineManager.lineCollections[0].lineData.limitTrain.Equals(0))
            lineManager.lineCollections[0].lineData.limitTrain = 10;
        if (!lineManager.lineCollections[0].lineData.sectionExpanded[1])
            lineManager.lineCollections[0].lineData.sectionExpanded[1] = lineManager.lineCollections[0].lineData.sectionExpanded[2] = lineManager.lineCollections[0].lineData.sectionExpanded[4] = true;
    }

    /// <summary>
    /// 모든 노선에 대한 라인 데이터 모음 배열
    /// </summary>
    /// <returns></returns>
    public LineData[] AssembleLineData()
    {
        LineData[] lineDatas = new LineData[lineManager.lineCollections.Length];
        for (int i = 0; i < lineDatas.Length; i++)
            lineDatas[i] = lineManager.lineCollections[i].lineData;

        return lineDatas;
    }

    /// <summary>
    /// 라인 데이터 세팅
    /// </summary>
    /// <param name="lineDatas">입력할 데이터</param>
    public void SetLineData(LineData[] lineDatas)
    {
        for (int i = 0; i < lineDatas.Length; i++)
        {
            int stationSize = lineManager.lineCollections[i].lineData.hasStation.Length;
            lineManager.lineCollections[i].SetLoadedData(lineDatas[i]);

            FixAll(i, stationSize);
        }
    }

    /// <summary>
    /// 배열의 길이가 잘못된 데이터 교정 작업
    /// </summary>
    /// <param name="line">노선 번호</param>
    /// <param name="stationSize">구간 크기</param>
    private void FixAll(int line, int stationSize)
    {
        int sectionSize = lineManager.lineCollections[line].purchaseStation.priceData.Sections.Length;
        FixData(ref lineManager.lineCollections[line].lineData.connected, sectionSize);
        FixData(ref lineManager.lineCollections[line].lineData.installed, sectionSize);
        FixData(ref lineManager.lineCollections[line].lineData.sectionExpanded, sectionSize);
        FixData(ref lineManager.lineCollections[line].lineData.hasAllStations, sectionSize);

        FixData(ref lineManager.lineCollections[line].lineData.hasStation, stationSize);

        if (!lineManager.lineCollections[line].purchaseStation.priceData.IsLightRail)
            FixData(ref lineManager.lineCollections[line].lineData.trainExpandStatus, 4);
        else
            FixData(ref lineManager.lineCollections[line].lineData.lineControlLevels, 5);
    }

    /// <summary>
    /// 특정 데이터의 배열 길이 교정 작업
    /// </summary>
    /// <param name="data">교정 대상 배열</param>
    /// <param name="sectionSize">배열 길이</param>
    private void FixData(ref bool[] data, int sectionSize)
    {
        if (data != null)
        {
            if (sectionSize != data.Length)
                data = new bool[sectionSize];
        }
        else
            data = new bool[sectionSize];
    }

    /// <summary>
    /// 특정 데이터의 배열 길이 교정 작업
    /// </summary>
    /// <param name="data">교정 대상 배열</param>
    /// <param name="sectionSize">배열 길이</param>
    private void FixData(ref int[] data, int size)
    {
        if (data != null)
        {
            if (size != data.Length)
                data = new int[size];
        }
        else
            data = new int[size];
    }

    /// <summary>
    /// 노선 데이터 로컬 저장
    /// </summary>
    public void SaveData()
    {
        LineData[] lineDatas = AssembleLineData();

        BinaryFormatter formatter = new BinaryFormatter();
        FileStream file = File.Create(Application.persistentDataPath + "/dataInfo.dat");
        formatter.Serialize(file, lineDatas);
        file.Close();
    }

    /// <summary>
    /// 로컬 노선 데이터 로딩
    /// </summary>
    public void LoadData()
    {
        BinaryFormatter formatter = new BinaryFormatter();
        FileStream file = null;
        LineData[] lineDatas = new LineData[lineManager.lineCollections.Length];
        try
        {
            file = File.Open(Application.persistentDataPath + "/dataInfo.dat", FileMode.Open);
            // 노선 데이터를 정상적으로 불러왔으면
            if (file != null && file.Length > 0)
            {
                // 역직렬화
                lineDatas = (LineData[])formatter.Deserialize(file);

                // 기존 플레이 데이터가 없는 경우 노선 추가에 대한 작업 스킵 처리
                if (lineDatas[0].numOfTrain == 0)
                    playManager.playData.didLineAdd314 = true;

                // 노선 추가 작업
                if (lineDatas.Length.Equals(4))
                {
                    lineManager.lineCollections[14].lineData = lineDatas[0];
                    lineManager.lineCollections[23].lineData = lineDatas[1];
                    lineManager.lineCollections[24].lineData = lineDatas[2];
                    lineManager.lineCollections[25].lineData = lineDatas[3];

                    if (!playManager.playData.didLineAdd314)
                        InsertNewLines(lineDatas);
                }
                else
                {
                    if (!playManager.playData.didLineAdd314)
                        InsertNewLines(lineDatas);
                    else
                        SetLineData(lineDatas);
                }

                file.Close();
            }
            else
            {
                //Debug.Log("Cannot load data file.");
                messageManager.ShowMessage("[ERROR] Cannot load data file.", 5f);
            }

        }
        catch (System.Exception e)
        {
            /*for(int i = 0; i < lineDatas.Length; i++)
            {
                lineManager.lineCollections[i].InitializeData();
            }*/
            Debug.Log(e.Message);
        }
        // 1호선 기본 제공 역에 대한 초기화 작업
        InitLine1();
    }

    /// <summary>
    /// 신규 노선 데이터 순서 정리
    /// </summary>
    private void InsertNewLines(LineData[] lineDatas)
    {
        int[] newLines = { 4, 10, 20, 23 };
        int k = 0, n = 0;
        for (int i = 0; i < 29; i++)
        {
            if (i == newLines[n])
            {
                if (n < newLines.Length - 1)
                    n++;
            }
            else if (k == 18)
            {
                lineDatas[20] = ConvertBD2SuinBD(lineDatas[18], lineDatas[20]);
                k++;
                i--;
            }
            else
            {
                lineManager.lineCollections[i].SetLoadedData(lineDatas[k]);
                k++;
            }
        }
        playManager.playData.didLineAdd314 = true;
    }

    /// <summary>
    /// 분당선과 수인분당선을 수인분당선 하나로 합병
    /// </summary>
    /// <param name="bdLineData">분당선 데이터</param>
    /// <param name="suinBdLineData">수인분당선 데이터</param>
    /// <returns></returns>
    private LineData ConvertBD2SuinBD(LineData bdLineData, LineData suinBdLineData)
    {
        LineData convertedData = new LineData();
        convertedData.limitTrain = suinBdLineData.limitTrain;
        convertedData.numOfTrain = suinBdLineData.numOfTrain;
        convertedData.numOfBase = suinBdLineData.numOfBase;
        convertedData.numOfBaseEx = suinBdLineData.numOfBaseEx;
        convertedData.hasStation = suinBdLineData.hasStation;
        convertedData.trainExpandStatus = suinBdLineData.trainExpandStatus;
        
        convertedData.installed = new bool[3];
        convertedData.connected = new bool[3];
        convertedData.sectionExpanded = new bool[3];
        convertedData.hasAllStations = new bool[3];

        convertedData.installed[0] = suinBdLineData.installed[0];
        convertedData.installed[1] = suinBdLineData.installed[0];
        convertedData.installed[2] = bdLineData.installed[0];

        convertedData.connected[0] = suinBdLineData.connected[0];
        convertedData.connected[1] = suinBdLineData.connected[0];
        convertedData.connected[2] = bdLineData.connected[0];

        convertedData.sectionExpanded[0] = suinBdLineData.sectionExpanded[0];
        convertedData.sectionExpanded[1] = suinBdLineData.sectionExpanded[0];
        convertedData.sectionExpanded[2] = bdLineData.sectionExpanded[0];
        return convertedData;
    }
}

[System.Serializable]
public class LineData
{
    /// <summary>
    /// 열차 개수 제한
    /// </summary>
    public int limitTrain;
    /// <summary>
    /// 열차 개수
    /// </summary>
    public int numOfTrain;
    /// <summary>
    /// 차량기지 구매 개수
    /// </summary>
    public int numOfBase;
    /// <summary>
    /// 차량기지 확장 횟수
    /// </summary>
    public int numOfBaseEx;
    /// <summary>
    /// 역 구매 여부
    /// </summary>
    public bool[] hasStation;
    /// <summary>
    /// 구간 연결 여부
    /// </summary>
    public bool[] connected;
    /// <summary>
    /// 구간의 역을 모두 구매했는지 여부
    /// </summary>
    public bool[] hasAllStations;
    /// <summary>
    /// 구간 스크린도어 설치 여부
    /// </summary>
    public bool[] installed;
    /// <summary>
    /// 열차 확장
    /// </summary>
    public int[] trainExpandStatus = new int[4];
    /// <summary>
    /// 노선 제어 관리 레벨
    /// </summary>
    public int[] lineControlLevels;
    /// <summary>
    /// 확장권 보유 여부
    /// </summary>
    public bool[] sectionExpanded;


}